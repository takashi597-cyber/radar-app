<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>子宮内膜レーダーチャート</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8fafc; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo } = React;

        // アイコンコンポーネントの代わり（SVG）
        const IconActivity = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-600"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;

        const App = () => {
            const [mode, setMode] = useState('cancer');
            const cancerItems = [
                { id: 'nuclearLayering', label: '核重積性', description: '5: 2~3層, 3: 一部, -2: 1層' },
                { id: 'atypicalClusters', label: '異形細胞集塊', description: '5: 篩状/樹枝状, 4: 分岐, 1: 円形' },
                { id: 'glandDensity', label: '腺密度', description: '5: 10個以上, 3: 6~7個, 1: なし' },
                { id: 'stromaAmount', label: '間質細胞の量', description: '5: 極少, 4: 少量, -2: 豊富' },
                { id: 'stromaClusters', label: '間質集塊の有無', description: '5: なし, 4: 少数, 1: 多数' },
                { id: 'cohesionLack', label: '結合性の欠如', description: '5: 著しく欠如, 3: 一部, 1: 保持' },
                { id: 'nuclearEnlargement', label: '核の大型化', description: '5: 大型, 3: 中型, 1: 小型' },
                { id: 'nuclearIrregularity', label: '核形不整', description: '5: 目立つ, 4: 一部, 3: なし' },
                { id: 'neutrophilCount', label: '好中球の数', description: '5: 30個~, 3: 10~20, 1: なし' },
                { id: 'neutrophilInvasion', label: '上皮内好中球侵入', description: '5: 多く認める, 3: 1個, 1: なし' },
            ];

            const hyperplasiaItems = [
                { id: 'nuclearLayering', label: '核重積性', description: '5: 2~3層, 3: 一部, -2: 1層' },
                { id: 'atypicalClusters', label: '異形細胞集塊', description: '5: 乳頭状/BTB, 3: 一部, 1: 円形' },
                { id: 'largeClusters', label: '大型細胞集塊', description: '5: 目立つ, 3: 一部, 1: なし' },
                { id: 'branchingClusters', label: '分岐細胞集塊', description: '5: 目立つ, 3: あり, 1: なし' },
                { id: 'glandDensity', label: '腺密度', description: '5: 6~7個~, 3: 4~5個, 1: 2個以下' },
                { id: 'terminalBranching', label: '有端分岐集塊', description: '5: 目立つ, 3: 数ヶ所, 1: なし' },
                { id: 'stromaComponent', label: '間質成分', description: '5: 極少, 3: 1:1, 1: 豊富' },
                { id: 'stromaClusters', label: '間質細胞集塊', description: '5: なし, 4: 少数, 1: 多数' },
                { id: 'nuclearEnlargement', label: '核の大型化', description: '5: 大型, 3: 中型, 1: 小型' },
                { id: 'neutrophilCount', label: '好中球の数', description: '5: 30個~, 3: 10~20, 1: 少数' },
            ];

            const initialScores = () => {
                const scores = {};
                [...cancerItems, ...hyperplasiaItems].forEach(item => scores[item.id] = 3);
                return scores;
            };

            const [scores, setScores] = useState(initialScores());
            const [bonuses, setBonuses] = useState({});

            const currentItems = mode === 'cancer' ? cancerItems : hyperplasiaItems;

            const totalScore = useMemo(() => {
                let sum = currentItems.reduce((acc, item) => acc + (scores[item.id] || 0), 0);
                if (mode === 'cancer') {
                    if (bonuses.necrosis) sum += 3;
                    if (bonuses.fibro) sum += 3;
                    if (bonuses.metaplasia) sum += 2;
                } else {
                    if (bonuses.metaplasia) sum += 2;
                    if (bonuses.eosin) sum += 2;
                }
                return sum;
            }, [scores, bonuses, mode]);

            const diagnosis = useMemo(() => {
                if (mode !== 'cancer') return { label: `増殖症スコア: ${totalScore}`, color: 'text-indigo-600', bg: 'bg-indigo-50' };
                if (totalScore >= 47) return { label: '要生検：悪性', color: 'text-red-600', bg: 'bg-red-50' };
                if (totalScore >= 40) return { label: '要生検：悪性を強く疑う', color: 'text-orange-600', bg: 'bg-orange-50' };
                if (totalScore >= 35) return { label: '要生検：悪性を疑う', color: 'text-yellow-600', bg: 'bg-yellow-50' };
                if (totalScore >= 30) return { label: '経過観察：異型内膜', color: 'text-blue-600', bg: 'bg-blue-50' };
                return { label: '良性', color: 'text-green-600', bg: 'bg-green-50' };
            }, [totalScore, mode]);

            // Chart rendering logic
            React.useEffect(() => {
                const ctx = document.getElementById('radarChart');
                if (!ctx) return;
                
                const existingChart = Chart.getChart(ctx);
                if (existingChart) existingChart.destroy();

                new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: currentItems.map(i => i.label),
                        datasets: [{
                            data: currentItems.map(i => scores[i.id]),
                            backgroundColor: mode === 'cancer' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(79, 70, 229, 0.2)',
                            borderColor: mode === 'cancer' ? 'rgb(239, 68, 68)' : 'rgb(79, 70, 229)',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        scales: { r: { min: -2, max: 5, ticks: { stepSize: 1 } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }, [scores, mode]);

            return (
                <div className="p-4 max-w-4xl mx-auto space-y-6">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border">
                        <h1 className="text-xl font-bold flex items-center gap-2 mb-4">
                            <IconActivity /> 大野式レーダーチャート
                        </h1>
                        <div className="flex bg-gray-100 p-1 rounded-xl mb-6 text-sm">
                            <button onClick={() => setMode('cancer')} className={`flex-1 py-2 rounded-lg ${mode === 'cancer' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}>体がん</button>
                            <button onClick={() => setMode('hyperplasia')} className={`flex-1 py-2 rounded-lg ${mode === 'hyperplasia' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}>増殖症</button>
                        </div>

                        <div className={`p-4 rounded-xl border mb-6 text-center ${diagnosis.bg}`}>
                            <div className="text-xs text-gray-500">総合スコア</div>
                            <div className="text-4xl font-black">{totalScore}</div>
                            <div className={`font-bold mt-1 ${diagnosis.color}`}>{diagnosis.label}</div>
                        </div>

                        <div className="mb-8"><canvas id="radarChart"></canvas></div>

                        <div className="space-y-6">
                            {currentItems.map(item => (
                                <div key={item.id} className="space-y-1">
                                    <div className="flex justify-between text-sm font-bold">
                                        <span>{item.label}</span>
                                        <span>{scores[item.id]}</span>
                                    </div>
                                    <input type="range" min="-2" max="5" value={scores[item.id]} onChange={(e) => setScores({...scores, [item.id]: parseInt(e.target.value)})} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                    <div className="text-[10px] text-gray-400">{item.description}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

