<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§é‡å¼ å­å®®å†…è†œãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        .active-btn { background-color: #4f46e5 !important; color: white !important; border-color: #4f46e5 !important; }
        .bonus-active { background-color: #f97316 !important; color: white !important; border-color: #f97316 !important; }
        canvas { max-height: 320px !important; width: 100% !important; }
        .pulse-animation { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const App = () => {
            const [mode, setMode] = useState('cancer');
            const [showResetConfirm, setShowResetConfirm] = useState(false);

            // Scoring Definitions
            const cancerItems = [
                { id: 'nuclearLayering', label: 'æ ¸é‡ç©æ€§', options: [{v:5, l:'5(2-3å±¤)'}, {v:3, l:'3(ä¸€éƒ¨)'}, {v:-2, l:'-2(1å±¤)'}] },
                { id: 'atypicalClusters', label: 'ç•°å½¢ç´°èƒé›†å¡Š', options: [{v:5, l:'5(ç¯©/æ¨¹)'}, {v:4, l:'4(åˆ†å²)'}, {v:1, l:'1(å††/ç®¡)'}] },
                { id: 'glandDensity', label: 'è…ºå¯†åº¦(x10)', options: [{v:5, l:'5(10å€‹~)'}, {v:3, l:'3(6-7å€‹)'}, {v:1, l:'1(ãªã—)'}] },
                { id: 'stromaAmount', label: 'é–“è³ªç´°èƒé‡', options: [{v:5, l:'5(æ¥µå°‘)'}, {v:4, l:'4(å°‘)'}, {v:3, l:'3'}, {v:-2, l:'-2(å¯Œ)'}] },
                { id: 'stromaClusters', label: 'é–“è³ªé›†å¡Š', options: [{v:5, l:'5(ãªã—)'}, {v:4, l:'4(å°‘)'}, {v:1, l:'1(å¤š)'}] },
                { id: 'cohesionLack', label: 'çµåˆæ€§æ¬ å¦‚', options: [{v:5, l:'5(è‘—)'}, {v:3, l:'3(ä¸€éƒ¨)'}, {v:1, l:'1(ä¿æŒ)'}] },
                { id: 'nuclearEnlargement', label: 'æ ¸å¤§å‹åŒ–', options: [{v:5, l:'5(å¤§)'}, {v:3, l:'3(ä¸­)'}, {v:1, l:'1(å°)'}] },
                { id: 'nuclearIrregularity', label: 'æ ¸å½¢ä¸æ•´', options: [{v:5, l:'5(æ˜)'}, {v:4, l:'4(ä¸€éƒ¨)'}, {v:3, l:'3(ãªã—)'}] },
                { id: 'neutrophilCount', label: 'å¥½ä¸­çƒ(x40)', options: [{v:5, l:'5(30~)'}, {v:3, l:'3(10~)'}, {v:1, l:'1(ç„¡)'}] },
                { id: 'neutrophilInvasion', label: 'ä¸Šçš®å†…å¥½ä¸­çƒ', options: [{v:5, l:'5(å¤š)'}, {v:3, l:'3(1å€‹)'}, {v:1, l:'1(ãªã—)'}] },
            ];

            const hyperplasiaItems = [
                { id: 'nuclearLayering', label: 'æ ¸é‡ç©æ€§', options: [{v:5, l:'5(2-3å±¤)'}, {v:3, l:'3(ä¸€éƒ¨)'}, {v:-2, l:'-2(1å±¤)'}] },
                { id: 'atypicalClusters', label: 'ç•°å½¢ç´°èƒé›†å¡Š', options: [{v:5, l:'5(ä¹³/BTB)'}, {v:3, l:'3'}, {v:1, l:'1(å††/ç®¡)'}] },
                { id: 'largeClusters', label: 'å¤§å‹ç´°èƒé›†å¡Š', options: [{v:5, l:'5(æœ‰)'}, {v:3, l:'3'}, {v:1, l:'1(ç„¡)'}] },
                { id: 'branchingClusters', label: 'åˆ†å²ç´°èƒé›†å¡Š', options: [{v:5, l:'5(æ˜)'}, {v:3, l:'3'}, {v:1, l:'1(ç„¡)'}] },
                { id: 'glandDensity', label: 'è…ºå¯†åº¦(x10)', options: [{v:5, l:'5(6å€‹~)'}, {v:3, l:'3'}, {v:1, l:'1(2å€‹â†“)'}] },
                { id: 'terminalBranching', label: 'æœ‰ç«¯åˆ†å²', options: [{v:5, l:'5(2å‰²~)'}, {v:3, l:'3'}, {v:1, l:'1(ç„¡)'}] },
                { id: 'stromaComponent', label: 'é–“è³ªæˆåˆ†', options: [{v:5, l:'5(æ¥µå°‘)'}, {v:3, l:'3(1:1)'}, {v:1, l:'1(è±Šå¯Œ)'}] },
                { id: 'stromaClusters', label: 'é–“è³ªé›†å¡Š', options: [{v:5, l:'5(ãªã—)'}, {v:4, l:'4'}, {v:1, l:'1(å¤š)'}] },
                { id: 'nuclearEnlargement', label: 'æ ¸å¤§å‹åŒ–', options: [{v:5, l:'5(å¤§)'}, {v:3, l:'3(ä¸­)'}, {v:1, l:'1(å°)'}] },
                { id: 'neutrophilCount', label: 'å¥½ä¸­çƒ(x40)', options: [{v:5, l:'5(30~)'}, {v:3, l:'3'}, {v:1, l:'1(å°‘)'}] },
            ];

            const getInitialScores = () => {
                const s = {};
                [...cancerItems, ...hyperplasiaItems].forEach(item => s[item.id] = null);
                return s;
            };

            const [scores, setScores] = useState(getInitialScores());
            const [bonuses, setBonuses] = useState({});

            const currentItems = mode === 'cancer' ? cancerItems : hyperplasiaItems;

            // å…¨é …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const isCompleted = useMemo(() => {
                return currentItems.every(item => scores[item.id] !== null);
            }, [scores, currentItems]);

            const executeReset = () => {
                setScores(getInitialScores());
                setBonuses({});
                setShowResetConfirm(false);
            };

            const totalScore = useMemo(() => {
                if (!isCompleted) return null;
                let sum = currentItems.reduce((acc, item) => acc + (scores[item.id] || 0), 0);
                if (mode === 'cancer') {
                    if (bonuses.necrosis) sum += 3;
                    if (bonuses.fibro) sum += 3;
                    if (bonuses.metaplasia) sum += 2;
                } else {
                    if (bonuses.metaplasia) sum += 2;
                    if (bonuses.eosin) sum += 2;
                }
                return sum;
            }, [scores, bonuses, mode, currentItems, isCompleted]);

            const diagnosis = useMemo(() => {
                if (!isCompleted) return { label: 'æœªå…¥åŠ›ã®é …ç›®ãŒã‚ã‚Šã¾ã™', color: 'text-slate-400', bg: 'bg-slate-100' };
                if (mode !== 'cancer') return { label: `å¢—æ®–ç—‡ã‚¹ã‚³ã‚¢åˆ¤å®šä¸­`, color: 'text-indigo-600', bg: 'bg-indigo-50' };
                
                if (totalScore >= 47) return { label: 'è¦ç”Ÿæ¤œï¼šæ‚ªæ€§', color: 'text-red-600', bg: 'bg-red-50' };
                if (totalScore >= 40) return { label: 'è¦ç”Ÿæ¤œï¼šæ‚ªæ€§ã‚’å¼·ãç–‘ã†', color: 'text-orange-600', bg: 'bg-orange-50' };
                if (totalScore >= 35) return { label: 'è¦ç”Ÿæ¤œï¼šæ‚ªæ€§ã‚’ç–‘ã†', color: 'text-yellow-600', bg: 'bg-yellow-50' };
                if (totalScore >= 30) return { label: 'çµŒéè¦³å¯Ÿï¼šç•°å‹å†…è†œ', color: 'text-blue-600', bg: 'bg-blue-50' };
                return { label: 'è‰¯æ€§', color: 'text-green-600', bg: 'bg-green-50' };
            }, [totalScore, mode, isCompleted]);

            useEffect(() => {
                const ctx = document.getElementById('radarChart');
                if (!ctx) return;
                const existingChart = Chart.getChart(ctx);
                if (existingChart) existingChart.destroy();

                const chartScores = currentItems.map(i => scores[i.id] === null ? null : scores[i.id]);

                new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: currentItems.map(i => i.label),
                        datasets: [{
                            data: chartScores,
                            backgroundColor: mode === 'cancer' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(79, 70, 229, 0.2)',
                            borderColor: mode === 'cancer' ? 'rgb(239, 68, 68)' : 'rgb(79, 70, 229)',
                            borderWidth: 2,
                            pointRadius: 4,
                            spanGaps: true // æœªå…¥åŠ›é …ç›®ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç·šã‚’ç¹‹ã
                        }]
                    },
                    options: {
                        scales: { r: { min: -2, max: 5, ticks: { display: false } } },
                        plugins: { legend: { display: false } },
                        maintainAspectRatio: false
                    }
                });
            }, [scores, mode, currentItems]);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50 flex flex-col relative">
                    {/* Confirmation Overlay */}
                    {showResetConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm">
                            <div className="bg-white rounded-3xl p-6 w-full shadow-2xl">
                                <h2 className="text-lg font-black mb-2">è©•ä¾¡ã‚’ãƒªã‚»ãƒƒãƒˆ</h2>
                                <p className="text-sm text-slate-500 mb-6 leading-relaxed">å…¨ã¦ã®å…¥åŠ›ã‚’æœªé¸æŠçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setShowResetConfirm(false)} className="py-3 font-bold bg-slate-100 text-slate-600 rounded-2xl">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button onClick={executeReset} className="py-3 font-bold bg-red-600 text-white rounded-2xl active:bg-red-700 shadow-lg shadow-red-200">ãƒªã‚»ãƒƒãƒˆ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <header className="bg-white px-4 pt-6 pb-4 shadow-sm border-b sticky top-0 z-20">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-lg font-black flex items-center gap-2">
                                <span className="bg-indigo-600 p-1.5 rounded-lg text-white">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                </span>
                                <span>å¤§é‡å¼ Radar App</span>
                            </h1>
                            <button onClick={() => setShowResetConfirm(true)} className="text-xs font-bold text-slate-400 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100 active:bg-red-50 active:text-red-600 transition-all">
                                ğŸ”„ æˆ»ã™
                            </button>
                        </div>
                        <div className="flex bg-slate-100 p-1.5 rounded-2xl text-sm font-bold">
                            <button onClick={() => setMode('cancer')} className={`flex-1 py-3 rounded-xl transition-all ${mode === 'cancer' ? 'bg-white shadow-sm text-indigo-700' : 'text-slate-500'}`}>ä½“ãŒã‚“</button>
                            <button onClick={() => setMode('hyperplasia')} className={`flex-1 py-3 rounded-xl transition-all ${mode === 'hyperplasia' ? 'bg-white shadow-sm text-indigo-700' : 'text-slate-500'}`}>å¢—æ®–ç—‡</button>
                        </div>
                    </header>

                    {/* Score Panel */}
                    <div className="p-4">
                        <div className={`p-6 rounded-[2rem] border-2 text-center transition-all duration-300 ${diagnosis.bg} ${isCompleted ? diagnosis.color.replace('text', 'border') : 'border-dashed border-slate-200'}`}>
                            <div className="text-[10px] font-black uppercase tracking-widest opacity-40">Total Score</div>
                            <div className={`text-6xl font-black my-1 tracking-tighter transition-all ${isCompleted ? 'text-slate-800 scale-110' : 'text-slate-200 pulse-animation'}`}>
                                {isCompleted ? totalScore : '--'}
                            </div>
                            <div className={`text-sm font-black ${diagnosis.color}`}>{diagnosis.label}</div>
                        </div>
                    </div>

                    {/* Chart Card */}
                    <div className="px-4 mb-4">
                        <div className="bg-white p-4 rounded-[2rem] border shadow-sm aspect-square flex items-center justify-center relative">
                            <canvas id="radarChart"></canvas>
                            {!isCompleted && (
                                <div className="absolute inset-0 flex items-center justify-center bg-white/20 pointer-events-none">
                                    <span className="text-[10px] font-bold text-slate-300 bg-white/80 px-4 py-2 rounded-full border shadow-sm">
                                        å…¥åŠ›ã«åˆã‚ã›ã¦ã‚°ãƒ©ãƒ•ãŒç”Ÿæˆã•ã‚Œã¾ã™
                                    </span>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Inputs */}
                    <div className="px-4 pb-20 space-y-6">
                        <div className="bg-white p-6 rounded-[2rem] border shadow-sm">
                            <h3 className="text-sm font-black mb-6 text-slate-800 flex items-center gap-2">
                                <span className="w-1.5 h-4 bg-indigo-600 rounded-full"></span>
                                åŸºæœ¬è©•ä¾¡ï¼ˆå…¨10é …ç›®ï¼‰
                            </h3>
                            <div className="space-y-10">
                                {currentItems.map(item => (
                                    <div key={item.id} className={`space-y-3 transition-opacity ${scores[item.id] === null ? 'opacity-100' : 'opacity-100'}`}>
                                        <div className="flex justify-between items-center px-1">
                                            <span className={`text-sm font-bold transition-colors ${scores[item.id] === null ? 'text-slate-800' : 'text-slate-400'}`}>
                                                {item.label} {scores[item.id] === null && <span className="text-red-500 ml-1 font-black text-xs">*</span>}
                                            </span>
                                            {scores[item.id] !== null && (
                                                <span className="text-[10px] font-black bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-lg border border-indigo-100">
                                                    Score: {scores[item.id]}
                                                </span>
                                            )}
                                        </div>
                                        <div className="flex gap-2">
                                            {item.options.map(opt => (
                                                <button
                                                    key={opt.v}
                                                    onClick={() => setScores({...scores, [item.id]: opt.v})}
                                                    className={`flex-1 py-4 text-[11px] font-bold rounded-2xl border transition-all active:scale-95 ${scores[item.id] === opt.v ? 'active-btn shadow-lg shadow-indigo-100' : 'bg-slate-50 text-slate-400 border-slate-100'}`}
                                                >
                                                    {opt.l}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Bonus Section (Always visible but score only added when basic items complete) */}
                        <div className="bg-white p-6 rounded-[2rem] border shadow-sm mb-10">
                            <h3 className="text-sm font-black mb-4 text-slate-800 flex items-center gap-2">
                                <span className="w-1.5 h-4 bg-orange-500 rounded-full"></span>
                                ç‰¹æ®Šæ‰€è¦‹
                            </h3>
                            <div className="flex flex-wrap gap-2">
                                {mode === 'cancer' ? (
                                    <>
                                        <BonusToggle active={bonuses.necrosis} onClick={() => setBonuses({...bonuses, necrosis: !bonuses.necrosis})} label="å£Šæ­» (+3)" />
                                        <BonusToggle active={bonuses.fibro} onClick={() => setBonuses({...bonuses, fibro: !bonuses.fibro})} label="ç·šç¶­è¡€ç®¡æ€§é–“è³ª (+3)" />
                                        <BonusToggle active={bonuses.metaplasia} onClick={() => setBonuses({...bonuses, metaplasia: !bonuses.metaplasia})} label="æ‰å¹³ä¸Šçš®åŒ–ç”Ÿ (+2)" />
                                    </>
                                ) : (
                                    <>
                                        <BonusToggle active={bonuses.metaplasia} onClick={() => setBonuses({...bonuses, metaplasia: !bonuses.metaplasia})} label="æ‰å¹³ä¸Šçš®åŒ–ç”Ÿ (+2)" />
                                        <BonusToggle active={bonuses.eosin} onClick={() => setBonuses({...bonuses, eosin: !bonuses.eosin})} label="å¥½é…¸æ€§åŒ–ç”Ÿ (+2)" />
                                    </>
                                )}
                            </div>
                            {!isCompleted && <p className="text-[10px] text-orange-400 mt-3 italic">* åŸºæœ¬é …ç›®ã®å…¥åŠ›å¾Œã«åŠ ç®—ã•ã‚Œã¾ã™</p>}
                        </div>
                    </div>

                    <footer className="py-8 text-center text-[10px] text-slate-400 px-6">
                        <p>Â© ä¸Šå°¾ä¸­å¤®ç·åˆç—…é™¢ å¤§é‡å–œä½œã€Œå¤§é‡å¼è¨ºæ–­åŸºæº–ã€</p>
                    </footer>
                </div>
            );
        };

        const BonusToggle = ({ active, onClick, label }) => (
            <button 
                onClick={onClick}
                className={`px-4 py-3 rounded-2xl text-xs font-bold border transition-all active:scale-95 ${active ? 'bonus-active shadow-lg shadow-orange-100' : 'bg-slate-50 text-slate-400 border-slate-100'}`}
            >
                {active ? 'âœ… ' : '+ '} {label}
            </button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

